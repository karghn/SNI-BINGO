<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SNI-GIM-BINGO</title>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af; --accent:#22d3ee;
      --blue:#60a5fa; --yellow:#fbbf24; --gray:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1222,#0b1020);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .app{max-width:1280px;margin:0 auto;padding:16px;display:grid;grid-template-rows:auto auto 1fr;gap:12px}
    header{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .title{font-weight:800;letter-spacing:.2px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--muted);border:1px solid #2a3342;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;user-select:none}
    .btn:hover{background:#263143}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.mode-edit{background:#1e3a8a;border-color:#1d4ed8}
    .btn.mode-shuffle{background:#78350f;border-color:#a16207}
    .btn.mode-view{background:#374151;border-color:#4b5563}
    .players{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .player{display:flex;align-items:center;gap:10px;background:#0f172a;border:1px solid #233048;padding:8px 10px;border-radius:10px;transition:box-shadow .2s,border-color .2s}
    .player.leader{box-shadow:0 0 12px 2px currentColor;border-color:currentColor}
    .badge{width:16px;height:16px;border-radius:999px;border:2px solid rgba(255,255,255,.18)}
    .pname{font-weight:700}
    .pscore{margin-left:auto;color:var(--accent);font-weight:800;font-variant-numeric:tabular-nums}
    .mode-badge{margin-left:8px;color:var(--sub);font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:14px}
    .card{border:1px solid #20314d;border-radius:16px;padding:10px;background:var(--panel);position:relative}
    .card .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .card .hdr .ctitle{font-weight:800}
    .tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .tile{position:relative;background:#0b1220;border:1px solid #1d2740;border-radius:10px;overflow:hidden;min-height:100px;display:grid;place-items:center;padding:8px;cursor:pointer;transition:transform .05s,background .2s,border-color .2s}
    .tile:hover{background:#0e162b}
    .tile img.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.28;pointer-events:none}
    .tile .content{position:relative;text-align:center;z-index:1}
    .tile .ttl{font-weight:700;font-size:13px;line-height:1.2}
    .tile .sub{font-size:11px;color:var(--sub)}
    .tile.claimed::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .claim-label{position:absolute;bottom:6px;right:6px;z-index:2;padding:3px 7px;border-radius:999px;font-size:11px;font-weight:800;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.15)}
    /* Visual modes */
    body.edit-mode .tile{border-style:dashed;border-color:var(--blue)}
    body.edit-mode .tile::before{content:"âœŽ";position:absolute;top:6px;left:6px;font-size:12px;color:var(--blue);z-index:2;background:rgba(0,0,0,.45);padding:0 4px;border-radius:4px}
    body.shuffle-mode .tile{border-style:dashed;border-color:var(--yellow);cursor:move}
    body.view-only .tile{filter:saturate(.6) brightness(.9);cursor:not-allowed}
    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .dialog{background:#0b1220;border:1px solid #20314d;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.45);padding:16px;max-width:520px;width:calc(100% - 24px)}
    .row{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin-bottom:8px}
    .inp{width:100%;background:#0a1324;color:var(--text);border:1px solid #223149;border-radius:10px;padding:10px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    /* Card tints */
    .tint-red{background:linear-gradient(180deg,rgba(220,38,38,.08),transparent)}
    .tint-blue{background:linear-gradient(180deg,rgba(59,130,246,.08),transparent)}
    .tint-green{background:linear-gradient(180deg,rgba(16,185,129,.08),transparent)}
    .tint-purple{background:linear-gradient(180deg,rgba(168,85,247,.08),transparent)}
    .tint-gold{background:linear-gradient(180deg,rgba(234,179,8,.10),transparent)}
    .tint-cyan{background:linear-gradient(180deg,rgba(6,182,212,.10),transparent)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title"><h2 style="margin:0">ðŸŽ¯ SNI-GIM-BINGO</h2></div>
      <div class="toolbar">
        <button class="btn mode-view" id="viewBtn">View Only: Off</button>
        <button class="btn mode-edit" id="editBtn">Edit Tiles: Off</button>
        <button class="btn mode-shuffle" id="shuffleBtn">Shuffle Mode: Off</button>
        <button class="btn" id="lockShuffleBtn">Lock Shuffle</button>
        <button class="btn" id="exportBtn">Export</button>
        <label class="btn" for="importFile">Import</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button class="btn" id="resetBtn">Reset</button>
      </div>
    </header>

    <section class="players" id="playersBar"></section>

    <section class="grid" id="cardsGrid"></section>
  </div>

  <!-- Assign Modal -->
  <div class="modal" id="assignModal">
    <div class="dialog">
      <h3 style="margin:0 0 8px" id="assignTitle">Assign Tile</h3>
      <div id="assignPicker"></div>
      <div class="actions">
        <button class="btn" id="unassignBtn">Unassign</button>
        <button class="btn" id="closeAssign">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Tile Modal -->
  <div class="modal" id="editModal">
    <div class="dialog">
      <h3 style="margin:0 0 8px">Edit Tile</h3>
      <div class="row"><label>Title</label><input class="inp" id="tileTitle" placeholder="Tile title" /></div>
      <div class="row"><label>Image</label><input class="inp" id="tileImage" type="file" accept="image/*" /></div>
      <div class="actions">
        <button class="btn" id="clearImg">Clear Image</button>
        <button class="btn" id="closeEdit">Cancel</button>
        <button class="btn mode-edit" id="saveEdit">Save</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "sni_gim_bingo_v1";

    const defaultPlayers = [
      { id:0, name:"Vaughn", color:"#ef4444" },
      { id:1, name:"Xaviar", color:"#f59e0b" },
      { id:2, name:"Thomas", color:"#10b981" },
      { id:3, name:"Rowen", color:"#3b82f6" },
      { id:4, name:"Daniel", color:"#a855f7" },
    ];

    const cardNames = ["Red","Blue","Green","Purple","Gold","Cyan"];
    const cardTints = ["tint-red","tint-blue","tint-green","tint-purple","tint-gold","tint-cyan"];

    // 6Ã—(3Ã—3) preset tasks with OSRS wiki images â€” in current order
    const PRESET = [
      [
        {title:"Zulrah KC",img:"https://oldschool.runescape.wiki/images/Zulrah.png"},
        {title:"Tormented Bracelet",img:"https://oldschool.runescape.wiki/images/Tormented_bracelet.png"},
        {title:"Moonclan Gear",img:"https://oldschool.runescape.wiki/images/Moonclan_robe_top.png"},
        {title:"Dragon Pickaxe",img:"https://oldschool.runescape.wiki/images/Dragon_pickaxe.png"},
        {title:"Whisperer KC",img:"https://oldschool.runescape.wiki/images/Whisperer.png"},
        {title:"Any Virtus Piece",img:"https://oldschool.runescape.wiki/images/Virtus_robe_top.png"},
        {title:"Mage Arena II Cape",img:"https://oldschool.runescape.wiki/images/Saradomin_cape.png"},
        {title:"90 Herblore",img:"https://oldschool.runescape.wiki/images/Herblore_icon.png"},
        {title:"Quest Cape",img:"https://oldschool.runescape.wiki/images/Quest_point_cape.png"}
      ],
      [
        {title:"99 Magic",img:"https://oldschool.runescape.wiki/images/Magic_icon.png"},
        {title:"Vardorvis KC",img:"https://oldschool.runescape.wiki/images/Vardorvis.png"},
        {title:"Any Pet",img:"https://oldschool.runescape.wiki/images/Pet_icon.png"},
        {title:"Ava's Assembler",img:"https://oldschool.runescape.wiki/images/Ava%27s_assembler.png"},
        {title:"Solo TOA 150",img:"https://oldschool.runescape.wiki/images/Tombs_of_Amascut.png"},
        {title:"Solo TOA 250",img:"https://oldschool.runescape.wiki/images/Tombs_of_Amascut.png"},
        {title:"Solo TOA 350",img:"https://oldschool.runescape.wiki/images/Tombs_of_Amascut.png"},
        {title:"Ancient Ring",img:"https://oldschool.runescape.wiki/images/Ring_of_shadows.png"},
        {title:"Dragon Axe",img:"https://oldschool.runescape.wiki/images/Dragon_axe.png"}
      ],
      [
        {title:"Occult Necklace",img:"https://oldschool.runescape.wiki/images/Occult_necklace.png"},
        {title:"Venator Bow",img:"https://oldschool.runescape.wiki/images/Venator_bow.png"},
        {title:"Fighter Torso",img:"https://oldschool.runescape.wiki/images/Fighter_torso.png"},
        {title:"Berserker Ring",img:"https://oldschool.runescape.wiki/images/Berserker_ring.png"},
        {title:"All Hard Diaries",img:"https://oldschool.runescape.wiki/images/Achievement_Diaries.png"},
        {title:"Enhanced Crystal Seed",img:"https://oldschool.runescape.wiki/images/Enhanced_crystal_weapon_seed.png"},
        {title:"Base 90 Stats",img:"https://oldschool.runescape.wiki/images/Stats_icon.png"},
        {title:"Base 70 Stats",img:"https://oldschool.runescape.wiki/images/Stats_icon.png"},
        {title:"Claws of Callisto",img:"https://oldschool.runescape.wiki/images/Claws_of_callisto.png"}
      ],
      [
        {title:"Dragon Harpoon",img:"https://oldschool.runescape.wiki/images/Dragon_harpoon.png"},
        {title:"Duke Sucellus KC",img:"https://oldschool.runescape.wiki/images/Duke_Sucellus.png"},
        {title:"Elite Void Upgrade",img:"https://oldschool.runescape.wiki/images/Elite_void_top.png"},
        {title:"Vorkath KC",img:"https://oldschool.runescape.wiki/images/Vorkath.png"},
        {title:"Osmumten's Fang",img:"https://oldschool.runescape.wiki/images/Osmumten%27s_fang.png"},
        {title:"126 Combat",img:"https://oldschool.runescape.wiki/images/Combat_icon.png"},
        {title:"Basilisk Jaw",img:"https://oldschool.runescape.wiki/images/Basilisk_jaw.png"},
        {title:"Leviathan KC",img:"https://oldschool.runescape.wiki/images/The_Leviathan.png"},
        {title:"Base 80 Stats",img:"https://oldschool.runescape.wiki/images/Stats_icon.png"}
      ],
      [
        {title:"Phantom Muspah KC",img:"https://oldschool.runescape.wiki/images/The_Frozen_General.png"},
        {title:"83 Construction",img:"https://oldschool.runescape.wiki/images/Construction_icon.png"},
        {title:"Full Crystal Armour",img:"https://oldschool.runescape.wiki/images/Crystal_body.png"},
        {title:"Tormented Synapse",img:"https://oldschool.runescape.wiki/images/Synapse.png"},
        {title:"Toxic Blowpipe",img:"https://oldschool.runescape.wiki/images/Toxic_blowpipe.png"},
        {title:"Rune Pouch",img:"https://oldschool.runescape.wiki/images/Rune_pouch.png"},
        {title:"Abyssal Whip",img:"https://oldschool.runescape.wiki/images/Abyssal_whip.png"},
        {title:"Lightbearer",img:"https://oldschool.runescape.wiki/images/Lightbearer.png"},
        {title:"All Medium Diaries",img:"https://oldschool.runescape.wiki/images/Achievement_Diaries.png"}
      ],
      [
        {title:"Quest Cape",img:"https://oldschool.runescape.wiki/images/Quest_point_cape.png"},
        {title:"Infernal Cape",img:"https://oldschool.runescape.wiki/images/Infernal_cape.png"},
        {title:"Max Cape",img:"https://oldschool.runescape.wiki/images/Max_cape.png"},
        {title:"Scythe of Vitur",img:"https://oldschool.runescape.wiki/images/Scythe_of_vitur.png"},
        {title:"Twisted Bow",img:"https://oldschool.runescape.wiki/images/Twisted_bow.png"},
        {title:"Tumeken's Shadow",img:"https://oldschool.runescape.wiki/images/Tumeken%27s_shadow.png"},
        {title:"Any Skilling Pet",img:"https://oldschool.runescape.wiki/images/Pet_icon.png"},
        {title:"Achievement Diary Cape",img:"https://oldschool.runescape.wiki/images/Achievement_diary_cape.png"},
        {title:"Collection Log 500+",img:"https://oldschool.runescape.wiki/images/Collection_log.png"}
      ]
    ];

    function defaultState(){
      return {
        players: JSON.parse(JSON.stringify(defaultPlayers)),
        cards: PRESET.map((arr, idx) => ({
          id: idx,
          title: cardNames[idx] + " Card",
          tint: cardTints[idx],
          tiles: arr.map(t => ({ title: t.title, img: t.img, winner: null }))
        })),
        editMode: false,
        shuffleMode: false,
        viewOnly: false,
        shuffleLocked: false
      };
    }

    let state = loadState();
    applyBodyModeFlags();

    function loadState(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const obj = JSON.parse(raw);
        if (!obj.players) obj.players = JSON.parse(JSON.stringify(defaultPlayers));
        if (!obj.cards || obj.cards.length !== 6) obj.cards = defaultState().cards;
        if (obj.shuffleLocked === undefined) obj.shuffleLocked = false;
        if (obj.viewOnly === undefined) obj.viewOnly = false;
        if (obj.editMode === undefined) obj.editMode = false;
        if (obj.shuffleMode === undefined) obj.shuffleMode = false;
        return obj;
      } catch(e){
        console.warn("Failed to load state, using defaults", e); 
        return defaultState();
      }
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // Scoring
    const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    function computeScores(){
      const scores = Object.fromEntries(state.players.map(p => [p.id, 0]));
      for(const card of state.cards){
        // tiles
        for(const t of card.tiles) if(t.winner != null) scores[t.winner] += 1;
        // lines
        for(const line of lines){
          const owners = line.map(i => card.tiles[i].winner);
          if(owners.every(o => o != null) && owners.every(o => o === owners[0])) scores[owners[0]] += 5;
        }
        // full card
        const owners = card.tiles.map(t => t.winner);
        if(owners.every(o => o != null) && owners.every(o => o === owners[0])) scores[owners[0]] += 10;
      }
      return scores;
    }

    // UI helpers
    function el(tag, attrs={}, ...children){
      const e = document.createElement(tag);
      for(const [k,v] of Object.entries(attrs)){
        if(k === "class") e.className = v;
        else if(k === "text") e.textContent = v;
        else if(k.startsWith("on") && typeof v === "function") e.addEventListener(k.substring(2), v);
        else e.setAttribute(k, v);
      }
      for(const c of children) e.append(c);
      return e;
    }
    function indexToRC(i){ const r = Math.floor(i/3)+1, c = (i%3)+1; return `R${r}C${c}`; }

    // Rendering
    function renderPlayersBar(){
      const wrap = document.getElementById("playersBar");
      wrap.innerHTML = "";
      const scores = computeScores();
      const max = Math.max(...Object.values(scores));
      for(const p of state.players){
        const card = el("div", { class:"player" });
        card.style.color = p.color;
        card.append(
          el("div", { class:"badge", style:`background:${p.color}` }),
          el("div", {}, el("div",{class:"pname",text:p.name}), el("div",{class:"mode-badge",text:`ID ${p.id+1}`})),
          el("div", { class:"pscore", text:String(scores[p.id]||0) })
        );
        if(scores[p.id] === max && max > 0) card.classList.add("leader");
        wrap.append(card);
      }
    }

    function renderCards(){
      const grid = document.getElementById("cardsGrid");
      grid.innerHTML = "";
      state.cards.forEach((card) => {
        const cardEl = el("div", { class:`card ${card.tint}` });
        const head = el("div", { class:"hdr" },
          el("div", { class:"ctitle", text:card.title }),
          el("div", { class:"sub", text: state.editMode ? "Click to edit" : (state.shuffleMode ? "Drag tiles to rearrange" : "Click to assign") })
        );
        const tiles = el("div", { class:"tiles" });
        card.tiles.forEach((t, i) => {
          const tile = el("div", { class:`tile${t.winner!=null ? " claimed":""}`, draggable: state.shuffleMode && !state.viewOnly ? "true" : "false", "data-card":String(card.id), "data-idx":String(i) });
          if(t.img){ tile.append(el("img", { class:"bg", src:t.img, alt:"" })); }
          const content = el("div", { class:"content" },
            el("div", { class:"ttl", text:t.title || `Tile ${i+1}` }),
            el("div", { class:"sub", text:`${card.title} â€¢ ${indexToRC(i)}` })
          );
          tile.append(content);

          if(t.winner != null){
            const owner = state.players.find(p => p.id === t.winner);
            tile.append(el("div", { class:"claim-label", style:`border-color:${owner.color};box-shadow:inset 0 0 0 1px ${owner.color}`, text:owner.name }));
          }

          // interactions
          if(!state.viewOnly){
            if(state.editMode){
              tile.addEventListener("click", () => openEdit(card.id, i));
            } else if(state.shuffleMode){
              tile.addEventListener("dragstart", onDragStart);
              tile.addEventListener("dragover", onDragOver);
              tile.addEventListener("drop", onDrop);
            } else {
              tile.addEventListener("click", () => openAssign(card.id, i));
            }
          }

          tiles.append(tile);
        });
        cardEl.append(head, tiles);
        grid.append(cardEl);
      });
    }

    // Drag & Drop
    let dragSrc = null;
    function onDragStart(e){
      const el = e.currentTarget;
      dragSrc = { cid:Number(el.dataset.card), idx:Number(el.dataset.idx) };
      e.dataTransfer.setData("text/plain", JSON.stringify(dragSrc));
    }
    function onDragOver(e){ e.preventDefault(); }
    function onDrop(e){
      e.preventDefault();
      const dstEl = e.currentTarget;
      const dst = { cid:Number(dstEl.dataset.card), idx:Number(dstEl.dataset.idx) };
      const src = dragSrc || JSON.parse(e.dataTransfer.getData("text/plain"));
      if(src && dst){
        const a = state.cards[src.cid].tiles[src.idx];
        const b = state.cards[dst.cid].tiles[dst.idx];
        state.cards[src.cid].tiles[src.idx] = b;
        state.cards[dst.cid].tiles[dst.idx] = a;
        saveState(); renderCards();
      }
      dragSrc = null;
    }

    // Assign Modal
    const assignModal = document.getElementById("assignModal");
    const assignTitle = document.getElementById("assignTitle");
    const assignPicker = document.getElementById("assignPicker");
    const unassignBtn = document.getElementById("unassignBtn");
    const closeAssignBtn = document.getElementById("closeAssign");
    let currentAssign = null;

    function openAssign(cid, idx){
      currentAssign = { cid, idx };
      const t = state.cards[cid].tiles[idx];
      assignTitle.textContent = `Assign: ${t.title}`;
      assignPicker.innerHTML = "";
      state.players.forEach(p => {
        const btn = el("button", { class:"btn", style:`width:100%;text-align:left;border-color:${p.color};border-width:2px` }, el("span",{text:p.name}));
        btn.style.borderColor = p.color;
        btn.addEventListener("click", () => {
          state.cards[cid].tiles[idx].winner = p.id;
          saveState();
          closeAssign();
          renderPlayersBar();
          renderCards();
        });
        const wrap = el("div", {}, btn);
        wrap.firstChild.prepend(el("span",{class:"badge",style:`background:${p.color};display:inline-block;margin-right:8px;vertical-align:middle`}));
        assignPicker.append(wrap);
      });
      assignModal.style.display = "flex";
      unassignBtn.onclick = () => {
        state.cards[cid].tiles[idx].winner = null;
        saveState(); closeAssign(); renderPlayersBar(); renderCards();
      };
    }
    function closeAssign(){ assignModal.style.display = "none"; currentAssign = null; }
    closeAssignBtn.onclick = closeAssign;

    // Edit Modal
    const editModal = document.getElementById("editModal");
    const tileTitleInp = document.getElementById("tileTitle");
    const tileImageInp = document.getElementById("tileImage");
    const saveEditBtn = document.getElementById("saveEdit");
    const clearImgBtn = document.getElementById("clearImg");
    const closeEditBtn = document.getElementById("closeEdit");
    let currentEdit = null;

    function openEdit(cid, idx){
      currentEdit = { cid, idx };
      const t = state.cards[cid].tiles[idx];
      tileTitleInp.value = t.title || "";
      tileImageInp.value = "";
      editModal.style.display = "flex";
    }
    function closeEdit(){ editModal.style.display = "none"; currentEdit = null; }
    closeEditBtn.onclick = closeEdit;
    clearImgBtn.onclick = () => {
      if(!currentEdit) return;
      state.cards[currentEdit.cid].tiles[currentEdit.idx].img = null;
      saveState(); renderCards();
    };
    saveEditBtn.onclick = async () => {
      if(!currentEdit) return;
      const t = state.cards[currentEdit.cid].tiles[currentEdit.idx];
      t.title = tileTitleInp.value.trim() || t.title;
      const file = tileImageInp.files[0];
      if(file){
        const dataUrl = await fileToDataURL(file);
        t.img = dataUrl;
      }
      saveState(); renderCards(); closeEdit();
    };
    function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // Toolbar
    const viewBtn = document.getElementById("viewBtn");
    const editBtn = document.getElementById("editBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const lockShuffleBtn = document.getElementById("lockShuffleBtn");
    const resetBtn = document.getElementById("resetBtn");
    const exportBtn = document.getElementById("exportBtn");
    const importFile = document.getElementById("importFile");

    function applyBodyModeFlags(){
      document.body.classList.toggle("view-only", !!state.viewOnly);
      document.body.classList.toggle("edit-mode", !!state.editMode);
      document.body.classList.toggle("shuffle-mode", !!state.shuffleMode);
    }

    function refreshToolbar(){
      viewBtn.textContent = "View Only: " + (state.viewOnly ? "On" : "Off");
      editBtn.textContent = "Edit Tiles: " + (state.editMode ? "On" : "Off");
      shuffleBtn.textContent = "Shuffle Mode: " + (state.shuffleMode ? "On" : "Off");
      shuffleBtn.disabled = state.shuffleLocked;
      lockShuffleBtn.disabled = state.shuffleLocked;
    }

    viewBtn.onclick = () => {
      state.viewOnly = !state.viewOnly;
      if(state.viewOnly){ state.editMode = false; state.shuffleMode = false; }
      saveState(); applyBodyModeFlags(); refreshToolbar(); renderCards();
    };
    editBtn.onclick = () => {
      if(state.viewOnly) return;
      state.editMode = !state.editMode;
      if(state.editMode) state.shuffleMode = false;
      saveState(); applyBodyModeFlags(); refreshToolbar(); renderCards();
    };
    shuffleBtn.onclick = () => {
      if(state.viewOnly || state.shuffleLocked) return;
      state.shuffleMode = !state.shuffleMode;
      if(state.shuffleMode) state.editMode = false;
      saveState(); applyBodyModeFlags(); refreshToolbar(); renderCards();
    };
    lockShuffleBtn.onclick = () => {
      if(state.shuffleLocked) return;
      state.shuffleLocked = true;
      state.shuffleMode = false;
      saveState(); applyBodyModeFlags(); refreshToolbar(); renderCards();
      alert("Shuffle is now locked for this board. Reset or Import a new state to unlock.");
    };
    resetBtn.onclick = () => {
      if(!confirm("Reset everything? This clears winners and custom edits.")) return;
      state = defaultState();
      saveState(); applyBodyModeFlags(); refreshToolbar(); renderPlayersBar(); renderCards();
    };
    exportBtn.onclick = () => {
      const blob = new Blob([JSON.stringify(state)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "SNI-GIM-BINGO-state.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };
    importFile.addEventListener("change", (e) => {
      const file = e.target.files[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const obj = JSON.parse(fr.result);
          if(!obj.cards || obj.cards.length !== 6) throw new Error("Invalid cards in JSON");
          state = obj;
          saveState(); applyBodyModeFlags(); refreshToolbar(); renderPlayersBar(); renderCards();
          e.target.value = "";
        } catch(err){ alert("Import failed: " + err.message); }
      };
      fr.readAsText(file);
    });

    // Initial render
    refreshToolbar();
    renderPlayersBar();
    renderCards();
  </script>
</body>
</html>
